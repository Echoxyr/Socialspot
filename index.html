await supabase
                            .from('event_participants')
                            .insert({
                                event_id: event.id,
                                user_id: user.id
                            });
                    }
                    loadParticipants();
                    if (onJoinToggle) onJoinToggle();
                } catch (err) {
                    console.error('Errore toggle partecipazione:', err);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{event.title}</h2>
                            <button className="modal-close" onClick={onClose}>
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="event-category" style={{marginBottom: '20px'}}>{event.category}</div>
                            <p style={{marginBottom: '20px', lineHeight: '1.6'}}>{event.description}</p>
                            
                            <div className="event-meta">
                                <div className="event-meta-item">
                                    <i className="fas fa-calendar"></i>
                                    <span>{new Date(event.event_date).toLocaleString('it-IT')}</span>
                                </div>
                                <div className="event-meta-item">
                                    <i className="fas fa-map-marker-alt"></i>
                                    <span>{event.location}</span>
                                </div>
                            </div>
                            
                            <div className="participants-count">
                                <i className="fas fa-users"></i>
                                <span>{participants.length} partecipanti</span>
                            </div>
                            
                            <button 
                                className={`btn-primary join-btn ${isJoined ? 'btn-secondary' : ''}`}
                                onClick={handleJoinToggle}
                                disabled={loading}
                            >
                                <i className={isJoined ? 'fas fa-check' : 'fas fa-user-plus'}></i>
                                {isJoined ? 'Abbandona evento' : 'Partecipa all\'evento'}
                            </button>

                            {/* Chat Evento */}
                            <EventChat eventId={event.id} user={user} isParticipant={isJoined} />
                        </div>
                    </div>
                </div>
            );
        }

        // Geocoding con OpenCage
        const getCoordinates = async (location) => {
            try {
                const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(location)}&key=YOUR_API_KEY&language=it&countrycode=it`);
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    return {
                        latitude: result.geometry.lat,
                        longitude: result.geometry.lng,
                        formatted_address: result.formatted
                    };
                }
            } catch (err) {
                console.error('Errore geocoding:', err);
            }
            // Fallback: coordinate fittizie per demo
            return {
                latitude: 41.9028 + (Math.random() - 0.5) * 0.1,
                longitude: 12.4964 + (Math.random() - 0.5) * 0.1,
                formatted_address: location
            };
        };

        // Feed Eventi
        function Feed({ user }) {
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [userLocation, setUserLocation] = useState('Roma, Italia');
            const [favorites, setFavorites] = useState([]);
            const [participants, setParticipants] = useState({});
            const [selectedEvent, setSelectedEvent] = useState(null);

            useEffect(() => {
                loadEvents();
                loadFavorites();
                loadParticipants();
            }, []);

            const loadEvents = async () => {
                try {
                    const { data, error } = await supabase
                        .from('events')
                        .select(`
                            *,
                            profiles!events_creator_id_fkey(username, location)
                        `)
                        .order('created_at', { ascending: false });
                    
                    if (!error) {
                        setEvents(data || []);
                    }
                } catch (err) {
                    console.error('Errore caricamento eventi:', err);
                } finally {
                    setLoading(false);
                }
            };

            const loadFavorites = async () => {
                try {
                    const { data } = await supabase
                        .from('event_favorites')
                        .select('event_id')
                        .eq('user_id', user.id);
                    setFavorites(data ? data.map(f => f.event_id) : []);
                } catch (err) {
                    console.error('Errore caricamento favoriti:', err);
                }
            };

            const loadParticipants = async () => {
                try {
                    const { data } = await supabase
                        .from('event_participants')
                        .select('event_id, user_id');
                    
                    const counts = {};
                    const userParticipations = [];
                    
                    (data || []).forEach(p => {
                        counts[p.event_id] = (counts[p.event_id] || 0) + 1;
                        if (p.user_id === user.id) {
                            userParticipations.push(p.event_id);
                        }
                    });
                    
                    setParticipants({ counts, userParticipations });
                } catch (err) {
                    console.error('Errore caricamento partecipanti:', err);
                }
            };

            const toggleFavorite = async (eventId) => {
                const isFavorite = favorites.includes(eventId);
                try {
                    if (isFavorite) {
                        await supabase
                            .from('event_favorites')
                            .delete()
                            .eq('event_id', eventId)
                            .eq('user_id', user.id);
                        setFavorites(favorites.filter(id => id !== eventId));
                    } else {
                        await supabase
                            .from('event_favorites')
                            .insert({ event_id: eventId, user_id: user.id });
                        setFavorites([...favorites, eventId]);
                    }
                } catch (err) {
                    console.error('Errore toggle favorito:', err);
                }
            };

            const toggleJoin = async (eventId) => {
                const isJoined = participants.userParticipations?.includes(eventId);
                try {
                    if (isJoined) {
                        await supabase
                            .from('event_participants')
                            .delete()
                            .eq('event_id', eventId)
                            .eq('user_id', user.id);
                    } else {
                        await supabase
                            .from('event_participants')
                            .insert({ event_id: eventId, user_id: user.id });
                    }
                    loadParticipants();
                } catch (err) {
                    console.error('Errore toggle partecipazione:', err);
                }
            };

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('it-IT', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            if (loading) return <div className="loading"><div className="spinner"></div></div>;

            return (
                <div className="feed">
                    <div className="location-section">
                        <div className="section-title">
                            <i className="fas fa-map-marker-alt"></i>
                            Eventi vicino a te
                            <span className="demo-badge">DEMO</span>
                        </div>
                        <p style={{color: '#888', fontSize: '14px'}}>{userLocation}</p>
                    </div>
                    
                    <div className="events-grid">
                        {events.length === 0 ? (
                            <div className="empty-state">
                                <i className="fas fa-calendar-times"></i>
                                <h3>Nessun evento trovato</h3>
                                <p>Sii il primo a creare un evento nella tua zona!</p>
                            </div>
                        ) : (
                            events.map(event => (
                                <div key={event.id} className="event-card">
                                    <div className="event-header">
                                        <div className="event-avatar">
                                            {event.profiles?.username?.[0]?.toUpperCase() || 'U'}
                                        </div>
                                        <div className="event-info">
                                            <div className="event-creator">{event.profiles?.username || 'Utente'}</div>
                                            <div className="event-location">{event.location}</div>
                                        </div>
                                        <div className="event-category">{event.category}</div>
                                    </div>
                                    
                                    <div className="event-content">
                                        <h3 className="event-title">{event.title}</h3>
                                        <p className="event-description">{event.description}</p>
                                        
                                        <div className="event-meta">
                                            <div className="event-meta-item">
                                                <i className="fas fa-calendar"></i>
                                                <span>{formatDate(event.event_date)}</span>
                                            </div>
                                            <div className="event-meta-item">
                                                <i className="fas fa-users"></i>
                                                <span>{participants.counts?.[event.id] || 0} partecipanti</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="event-actions">
                                        <button 
                                            className={`action-btn ${favorites.includes(event.id) ? 'liked' : ''}`}
                                            onClick={() => toggleFavorite(event.id)}
                                        >
                                            <i className={favorites.includes(event.id) ? 'fas fa-heart' : 'far fa-heart'}></i>
                                            Mi piace
                                        </button>
                                        <button 
                                            className={`action-btn ${participants.userParticipations?.includes(event.id) ? 'joined' : ''}`}
                                            onClick={() => toggleJoin(event.id)}
                                        >
                                            <i className="fas fa-user-plus"></i>
                                            {participants.userParticipations?.includes(event.id) ? 'Iscritto' : 'Partecipa'}
                                        </button>
                                        <button 
                                            className="action-btn"
                                            onClick={() => setSelectedEvent(event)}
                                        >
                                            <i className="fas fa-info-circle"></i>
                                            Dettagli
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {selectedEvent && (
                        <EventModal 
                            event={selectedEvent} 
                            onClose={() => setSelectedEvent(null)} 
                            user={user}
                            onJoinToggle={loadParticipants}
                        />
                    )}
                </div>
            );
        }

        // Ricerca con Utenti Demo
        function Search({ user }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [events, setEvents] = useState([]);
            const [people, setPeople] = useState([]);
            const [filteredEvents, setFilteredEvents] = useState([]);
            const [filteredPeople, setFilteredPeople] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState('');

            useEffect(() => {
                loadData();
            }, []);

            useEffect(() => {
                filterResults();
            }, [searchTerm, selectedCategory, events, people]);

            const loadData = async () => {
                setLoading(true);
                try {
                    // Carica eventi
                    const { data: eventsData, error: eventsError } = await supabase
                        .from('events')
                        .select(`
                            *,
                            profiles!events_creator_id_fkey(username)
                        `)
                        .order('event_date', { ascending: true });
                    
                    if (!eventsError) {
                        setEvents(eventsData || []);
                        setFilteredEvents(eventsData || []);
                    }

                    // Carica utenti reali + demo
                    const { data: realUsers } = await supabase
                        .from('profiles')
                        .select('id, username, bio, location')
                        .neq('id', user.id);

                    const allPeople = [
                        ...(realUsers || []),
                        ...DEMO_USERS.filter(demo => demo.id !== user.id)
                    ];
                    
                    setPeople(allPeople);
                    setFilteredPeople(allPeople);
                } catch (err) {
                    console.error('Errore caricamento dati:', err);
                } finally {
                    setLoading(false);
                }
            };

            const filterResults = () => {
                let filteredEvts = events;
                let filteredPpl = people;
                
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredEvts = filteredEvts.filter(event => 
                        event.title.toLowerCase().includes(term) ||
                        event.description.toLowerCase().includes(term) ||
                        event.location.toLowerCase().includes(term) ||
                        event.profiles?.username.toLowerCase().includes(term)
                    );
                    
                    filteredPpl = filteredPpl.filter(person =>
                        person.username?.toLowerCase().includes(term) ||
                        person.bio?.toLowerCase().includes(term) ||
                        person.location?.toLowerCase().includes(term)
                    );
                }
                
                if (selectedCategory) {
                    filteredEvts = filteredEvts.filter(event => event.category === selectedCategory);
                }
                
                setFilteredEvents(filteredEvts);
                setFilteredPeople(filteredPpl);
            };

            return (
                <div className="search-page">
                    <input
                        type="text"
                        className="search-bar"
                        placeholder="Cerca eventi, luoghi, persone..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    
                    <div style={{marginBottom: '30px'}}>
                        <div className="section-title">
                            <i className="fas fa-filter"></i>
                            Filtra per categoria
                        </div>
                        <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px', marginTop: '10px'}}>
                            <button 
                                className={`btn-secondary ${!selectedCategory ? 'active' : ''}`}
                                onClick={() => setSelectedCategory('')}
                                style={{fontSize: '12px', padding: '8px 12px'}}
                            >
                                Tutte
                            </button>
                            {CATEGORIES.map(cat => (
                                <button 
                                    key={cat}
                                    className={`btn-secondary ${selectedCategory === cat ? 'active' : ''}`}
                                    onClick={() => setSelectedCategory(cat)}
                                    style={{fontSize: '12px', padding: '8px 12px'}}
                                >
                                    {cat}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Sezione Persone */}
                    {filteredPeople.length > 0 && (
                        <div className="people-section">
                            <div className="section-title">
                                <i className="fas fa-users"></i>
                                Persone ({filteredPeople.length})
                                <span className="demo-badge">DEMO</span>
                            </div>
                            <div className="people-grid">
                                {filteredPeople.map(person => (
                                    <div key={person.id} className="person-card">
                                        <div className="person-avatar">
                                            {person.username?.[0]?.toUpperCase() || 'U'}
                                        </div>
                                        <div className="person-name">{person.username}</div>
                                        <div className="person-bio">{person.bio}</div>
                                        <div style={{fontSize: '12px', color: '#667eea', marginBottom: '10px'}}>
                                            <i className="fas fa-map-marker-alt"></i> {person.location}
                                        </div>
                                        <button className="btn-secondary" style={{fontSize: '12px', padding: '6px 12px'}}>
                                            Segui
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Sezione Eventi */}
                    {loading ? (
                        <div className="loading"><div className="spinner"></div></div>
                    ) : (
                        <div className="events-grid">
                            {filteredEvents.length === 0 && filteredPeople.length === 0 ? (
                                <div className="empty-state">
                                    <i className="fas fa-search"></i>
                                    <h3>Nessun risultato</h3>
                                    <p>Prova con altri termini di ricerca</p>
                                </div>
                            ) : filteredEvents.length > 0 ? (
                                <div>
                                    <div className="section-title">
                                        <i className="fas fa-calendar"></i>
                                        Eventi ({filteredEvents.length})
                                    </div>
                                    {filteredEvents.map(event => (
                                        <div key={event.id} className="event-card">
                                            <div className="event-header">
                                                <div className="event-avatar">
                                                    {event.profiles?.username?.[0]?.toUpperCase() || 'U'}
                                                </div>
                                                <div className="event-info">
                                                    <div className="event-creator">{event.profiles?.username || 'Utente'}</div>
                                                    <div className="event-location">{event.location}</div>
                                                </div>
                                                <div className="event-category">{event.category}</div>
                                            </div>
                                            <div className="event-content">
                                                <h3 className="event-title">{event.title}</h3>
                                                <p className="event-description">{event.description}</p>
                                                <div className="event-meta">
                                                    <div className="event-meta-item">
                                                        <i className="fas fa-calendar"></i>
                                                        <span>{new Date(event.event_date).toLocaleDateString('it-IT')}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : null}
                        </div>
                    )}
                </div>
            );
        }

        // Creazione Evento con Geocoding
        function Create({ user, onEventCreated }) {
            const [formData, setFormData] = useState({
                title: '',
                description: '',
                category: '',
                location: '',
                event_date: ''
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setSuccess('');

                try {
                    // Get coordinates per la location
                    const coordinates = await getCoordinates(formData.location);
                    
                    const { error } = await supabase
                        .from('events')
                        .insert({
                            ...formData,
                            creator_id: user.id,
                            latitude: coordinates.latitude,
                            longitude: coordinates.longitude
                        });

                    if (error) {
                        setError(error.message);
                    } else {
                        setSuccess('Evento creato con successo!');
                        setFormData({
                            title: '',
                            description: '',
                            category: '',
                            location: '',
                            event_date: ''
                        });
                        if (onEventCreated) {
                            setTimeout(() => onEventCreated(), 2000);
                        }
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleChange = (field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            return (
                <div className="create-page">
                    <div className="section-title">
                        <i className="fas fa-plus-circle"></i>
                        Crea nuovo evento
                    </div>
                    
                    <form onSubmit={handleSubmit} className="create-form">
                        <div className="form-row">
                            <div className="form-group">
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="Titolo evento"
                                    value={formData.title}
                                    onChange={(e) => handleChange('title', e.target.value)}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <select
                                    className="form-input form-select"
                                    value={formData.category}
                                    onChange={(e) => handleChange('category', e.target.value)}
                                    required
                                >
                                    <option value="">Seleziona categoria</option>
                                    {CATEGORIES.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="form-group">
                            <textarea
                                className="form-input form-textarea"
                                placeholder="Descrizione evento"
                                value={formData.description}
                                onChange={(e) => handleChange('description', e.target.value)}
                                required
                            />
                        </div>

                        <div className="form-row">
                            <div className="form-group">
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="Luogo (es. Milano, Roma, Torino)"
                                    value={formData.location}
                                    onChange={(e) => handleChange('location', e.target.value)}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <input
                                    type="datetime-local"
                                    className="form-input"
                                    value={formData.event_date}
                                    onChange={(e) => handleChange('event_date', e.target.value)}
                                    required
                                />
                            </div>
                        </div>

                        {error && <div className="error-message">{error}</div>}
                        {success && <div className="success-message">{success}</div>}

                        <button type="submit" className="btn-primary" disabled={loading}>
                            {loading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-calendar-plus"></i>}
                            {loading ? 'Creazione...' : 'Crea Evento'}
                        </button>
                    </form>
                </div>
            );
        }

        // Notifiche
        function Notifications({ user }) {
            const [notifications, setNotifications] = useState([]);
            const [loading, setLoading] = useState(true);
            const [unreadCount, setUnreadCount] = useState(0);

            useEffect(() => {
                loadNotifications();
            }, []);

            const loadNotifications = async () => {
                try {
                    const { data, error } = await supabase
                        .from('notifications')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false });
                    
                    if (!error) {
                        setNotifications(data || []);
                        setUnreadCount(data?.filter(n => !n.is_read).length || 0);
                    }
                } catch (err) {
                    console.error('Errore caricamento notifiche:', err);
                } finally {
                    setLoading(false);
                }
            };

            const markAsRead = async (notificationId) => {
                try {
                    await supabase
                        .from('notifications')
                        .update({ is_read: true })
                        .eq('id', notificationId);
                    
                    setNotifications(prev =>
                        prev.map(notif =>
                            notif.id === notificationId
                                ? { ...notif, is_read: true }
                                : notif
                        )
                    );
                    setUnreadCount(prev => Math.max(0, prev - 1));
                } catch (err) {
                    console.error('Errore aggiornamento notifica:', err);
                }
            };

            if (loading) return <div className="loading"><div className="spinner"></div></div>;

            return (
                <div className="notifications-page">
                    <div className="section-title">
                        <i className="fas fa-bell"></i>
                        Notifiche
                        {unreadCount > 0 && (
                            <span style={{
                                background: '#ff3b30',
                                color: 'white',
                                borderRadius: '10px',
                                padding: '2px 8px',
                                fontSize: '12px',
                                marginLeft: '10px'
                            }}>
                                {unreadCount}
                            </span>
                        )}
                    </div>
                    
                    {notifications.length === 0 ? (
                        <div className="empty-state">
                            <i className="fas fa-bell-slash"></i>
                            <h3>Nessuna notifica</h3>
                            <p>Quando avrai nuove notifiche, le vedrai qui</p>
                        </div>
                    ) : (
                        notifications.map(notif => (
                            <div 
                                key={notif.id} 
                                className={`notification-item ${!notif.is_read ? 'unread' : ''}`}
                                onClick={() => !notif.is_read && markAsRead(notif.id)}
                                style={{
                                    opacity: notif.is_read ? 0.7 : 1,
                                    borderLeft: notif.is_read ? 'none' : '4px solid #667eea',
                                    cursor: !notif.is_read ? 'pointer' : 'default'
                                }}
                            >
                                <div className="notification-avatar">
                                    <i className="fas fa-bell"></i>
                                </div>
                                <div className="notification-content">
                                    <div className="notification-text">
                                        <strong>{notif.title}</strong><br />
                                        {notif.content}
                                    </div>
                                    <div className="notification-time">
                                        {new Date(notif.created_at).toLocaleString('it-IT')}
                                    </div>
                                </div>
                                {!notif.is_read && (
                                    <div style={{
                                        width: '8px',
                                        height: '8px',
                                        backgroundColor: '#667eea',
                                        borderRadius: '50%'
                                    }}></div>
                                )}
                            </div>
                        ))
                    )}
                </div>
            );
        }

        // Profilo con Statistiche Reali
        function Profile({ user, onSignOut }) {
            const [profile, setProfile] = useState(null);
            const [myEvents, setMyEvents] = useState([]);
            const [stats, setStats] = useState({ events: 0, followers: 0, following: 0 });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadProfile();
                loadMyEvents();
            }, []);

            useEffect(() => {
                if (myEvents.length >= 0) {
                    calculateStats();
                }
            }, [myEvents]);

            const loadProfile = async () => {
                try {
                    const { data } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    setProfile(data || {
                        username: user.email.split('@')[0],
                        bio: 'Nuovo su SocialNet'
                    });
                } catch (err) {
                    console.error('Errore caricamento profilo:', err);
                }
            };

            const loadMyEvents = async () => {
                try {
                    const { data } = await supabase
                        .from('events')
                        .select('*')
                        .eq('creator_id', user.id)
                        .order('created_at', { ascending: false });
                    
                    setMyEvents(data || []);
                } catch (err) {
                    console.error('Errore caricamento eventi:', err);
                }
            };

            const calculateStats = async () => {
                try {
                    // Eventi creati (reale)
                    const eventsCreated = myEvents.length;
                    
                    // Partecipanti totali ai miei eventi (reale)
                    let totalParticipants = 0;
                    if (myEvents.length > 0) {
                        const { data: participantsData } = await supabase
                            .from('event_participants')
                            .select('event_id')
                            .in('event_id', myEvents.map(e => e.id));
                        totalParticipants = participantsData?.length || 0;
                    }
                    
                    // Eventi a cui partecipo (reale)
                    const { data: myParticipations } = await supabase
                        .from('event_participants')
                        .select('event_id')
                        .eq('user_id', user.id);
                    
                    const participationsCount = myParticipations?.length || 0;
                    
                    setStats({
                        events: eventsCreated,
                        followers: totalParticipants, // Follower = persone che partecipano ai miei eventi
                        following: participationsCount // Following = eventi a cui partecipo
                    });
                } catch (err) {
                    console.error('Errore calcolo statistiche:', err);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) return <div className="loading"><div className="spinner"></div></div>;

            return (
                <div className="profile-page">
                    <div className="profile-header">
                        <div className="profile-avatar-large">
                            {profile?.username?.[0]?.toUpperCase() || user.email[0].toUpperCase()}
                        </div>
                        <h2>{profile?.username || user.email.split('@')[0]}</h2>
                        <p style={{color: '#888', margin: '10px 0'}}>{profile?.bio}</p>
                        
                        <div className="profile-stats">
                            <div className="stat-item">
                                <div className="stat-number">{stats.events}</div>
                                <div className="stat-label">Eventi</div>
                            </div>
                            <div className="stat-item">
                                <div className="stat-number">{stats.followers}</div>
                                <div className="stat-label">Follower</div>
                            </div>
                            <div className="stat-item">
                                <div className="stat-number">{stats.following}</div>
                                <div className="stat-label">Seguiti</div>
                            </div>
                        </div>
                        
                        <div className="profile-actions">
                            <button className="profile-btn">Modifica profilo</button>
                            <button className="profile-btn secondary" onClick={onSignOut}>Logout</button>
                        </div>
                    </div>
                    
                    <div className="my-events-section">
                        <div className="section-title">
                            <i className="fas fa-calendar-check"></i>
                            I miei eventi ({myEvents.length})
                        </div>
                        
                        {myEvents.length === 0 ? (
                            <div className="empty-state">
                                <i className="fas fa-calendar-plus"></i>
                                <h3>Nessun evento creato</h3>
                                <p>Inizia creando il tuo primo evento!</p>
                            </div>
                        ) : (
                            <div className="events-grid">
                                {myEvents.map(event => (
                                    <div key={event.id} className="event-card">
                                        <div className="event-content">
                                            <h3 className="event-title">{event.title}</h3>
                                            <p className="event-description">{event.description}</p>
                                            <div className="event-meta">
                                                <div className="event-meta-item">
                                                    <i className="fas fa-calendar"></i>
                                                    <span>{new Date(event.event_date).toLocaleDateString('it-IT')}</span>
                                                </div>
                                                <div className="event-meta-item">
                                                    <i className="fas fa-map-marker-alt"></i>
                                                    <span>{event.location}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // App Principale
        function MainApp({ user, onSignOut }) {
            const [currentPage, setCurrentPage] = useState('feed');
            const [unreadNotifications, setUnreadNotifications] = useState(0);

            useEffect(() => {
                // Carica conteggio notifiche non lette
                loadUnreadCount();
                
                // Realtime per notifiche
                const channel = supabase.channel('notifications')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'notifications',
                        filter: `user_id=eq.${user.id}`
                    }, () => {
                        loadUnreadCount();
                    })
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, [user.id]);

            const loadUnreadCount = async () => {
                try {
                    const { data } = await supabase
                        .from('notifications')
                        .select('id')
                        .eq('user_id', user.id)
                        .eq('is_read', false);
                    
                    setUnreadNotifications(data?.length || 0);
                } catch (err) {
                    console.error('Errore conteggio notifiche:', err);
                }
            };

            const pages = {
                feed: <Feed user={user} />,
                search: <Search user={user} />,
                create: <Create user={user} onEventCreated={() => setCurrentPage('feed')} />,
                notifications: <Notifications user={user} />,
                profile: <Profile user={user} onSignOut={onSignOut} />
            };

            return (
                <div className="app">
                    <div className="top-bar">
                        <div className="logo-text">SocialNet</div>
                        <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                            <span style={{color: '#888', fontSize: '14px'}}>
                                Ciao, {user.email.split('@')[0]}
                            </span>
                        </div>
                    </div>

                    <div className="content">
                        {pages[currentPage]}
                    </div>

                    <div className="bottom-nav">
                        <div 
                            className={`nav-item ${currentPage === 'feed' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('feed')}
                        >
                            <i className="fas fa-home"></i>
                            <span>Home</span>
                        </div>
                        <div 
                            className={`nav-item ${currentPage === 'search' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('search')}
                        >
                            <i className="fas fa-search"></i>
                            <span>Cerca</span>
                        </div>
                        <div 
                            className={`nav-item ${currentPage === 'create' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('create')}
                        >
                            <i className="fas fa-plus"></i>
                            <span>Crea</span>
                        </div>
                        <div 
                            className={`nav-item ${currentPage === 'notifications' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('notifications')}
                        >
                            <i className="fas fa-heart"></i>
                            <span>Notifiche</span>
                            {unreadNotifications > 0 && (
                                <div className="nav-badge">{unreadNotifications}</div>
                            )}
                        </div>
                        <div 
                            className={`nav-item ${currentPage === 'profile' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('profile')}
                        >
                            <i className="fas fa-user"></i>
                            <span>Profilo</span>
                        </div>
                    </div>
                </div>
            );
        }

        // App Root
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    setLoading(false);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                });

                return () => subscription.unsubscribe();
            }, []);

            const handleSignOut = async () => {
                await supabase.auth.signOut();
                setUser(null);
            };

            if (loading) return <div className="loading"><div className="spinner"></div></div>;
            if (!user) return <Onboarding onComplete={setUser} />;
            return <MainApp user={user} onSignOut={handleSignOut} />;
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html><!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialNet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; }
        .app { min-height: 100vh; background: #000; }
        .top-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid #333; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 999; }
        .logo-text { font-size: 24px; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .content { padding-top: 70px; padding-bottom: 90px; min-height: 100vh; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid #333; display: flex; padding: 10px 0; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px; cursor: pointer; color: #888; transition: all 0.3s; position: relative; }
        .nav-item.active { color: #667eea; }
        .nav-item i { font-size: 24px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .nav-badge { position: absolute; top: 5px; right: 20px; background: #ff3b30; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; min-width: 18px; text-align: center; }
        .onboarding { min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .onboarding-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 20px; padding: 40px; text-align: center; max-width: 400px; width: 100%; border: 1px solid rgba(255,255,255,0.2); }
        .logo { width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 32px; font-weight: bold; color: white; }
        .auth-tabs { display: flex; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 4px; margin-bottom: 30px; }
        .auth-tab { flex: 1; padding: 12px; background: none; border: none; color: rgba(255,255,255,0.7); border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .auth-tab.active { background: rgba(255,255,255,0.2); color: white; }
        .form-group { margin-bottom: 20px; }
        .form-input { width: 100%; padding: 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: white; font-size: 16px; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: rgba(255,255,255,0.4); background: rgba(255,255,255,0.15); }
        .form-input::placeholder { color: rgba(255,255,255,0.5); }
        .form-textarea { min-height: 120px; resize: vertical; font-family: inherit; }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 12px center; background-repeat: no-repeat; background-size: 16px; padding-right: 40px; }
        .btn-primary { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:hover { background: #5a67d8; transform: translateY(-1px); }
        .feed { padding: 0; }
        .event-card { background: #1a1a1a; border-radius: 16px; margin: 20px; padding: 20px; border: 1px solid #333; transition: all 0.3s; }
        .event-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .event-header { display: flex; align-items: center; margin-bottom: 15px; gap: 12px; }
        .event-avatar { width: 50px; height: 50px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; }
        .event-info { flex: 1; }
        .event-creator { font-weight: 600; font-size: 16px; }
        .event-location { font-size: 14px; color: #888; }
        .event-category { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .event-content { margin: 15px 0; }
        .event-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .event-description { color: #ccc; line-height: 1.6; margin-bottom: 15px; }
        .event-meta { display: flex; flex-wrap: wrap; gap: 15px; margin: 15px 0; }
        .event-meta-item { display: flex; align-items: center; gap: 8px; color: #888; font-size: 14px; }
        .event-meta-item i { color: #667eea; }
        .event-actions { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { background: none; border: 1px solid #333; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .action-btn:hover { border-color: #667eea; color: #667eea; }
        .action-btn.liked { border-color: #ff3b30; color: #ff3b30; }
        .action-btn.joined { background: #667eea; border-color: #667eea; }
        .loading { display: flex; align-items: center; justify-content: center; min-height: 50vh; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .search-page, .create-page, .notifications-page, .profile-page { padding: 20px; }
        .search-bar { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 12px 16px; color: white; width: 100%; margin-bottom: 20px; font-size: 16px; }
        .search-bar:focus { outline: none; border-color: #667eea; }
        .location-section { margin-bottom: 30px; background: #1a1a1a; border-radius: 12px; padding: 20px; border: 1px solid #333; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .section-title i { color: #667eea; }
        .events-grid { display: grid; gap: 20px; }
        .create-form { background: #1a1a1a; border-radius: 16px; padding: 30px; margin: 20px; border: 1px solid #333; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .notification-item { display: flex; align-items: center; padding: 15px; background: #1a1a1a; border-radius: 12px; margin-bottom: 10px; gap: 12px; border: 1px solid #333; transition: all 0.3s; }
        .notification-item:hover { border-color: #667eea; }
        .notification-avatar { width: 40px; height: 40px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .notification-content { flex: 1; }
        .notification-text { font-size: 14px; margin-bottom: 5px; }
        .notification-time { font-size: 12px; color: #888; }
        .notification-action { background: #667eea; border: none; border-radius: 8px; padding: 8px 16px; color: white; font-size: 12px; cursor: pointer; }
        .profile-header { text-align: center; margin-bottom: 30px; background: #1a1a1a; border-radius: 16px; padding: 30px; border: 1px solid #333; }
        .profile-avatar-large { width: 100px; height: 100px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 36px; color: white; font-weight: bold; }
        .profile-stats { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 20px; font-weight: bold; }
        .stat-label { font-size: 12px; color: #888; }
        .profile-actions { display: flex; gap: 10px; margin: 20px 0; }
        .profile-btn { flex: 1; padding: 12px; background: #667eea; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .profile-btn:hover { background: #5a67d8; }
        .profile-btn.secondary { background: #333; }
        .profile-btn.secondary:hover { background: #444; }
        .my-events-section { background: #1a1a1a; border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .error-message { background: rgba(239,68,68,0.2); color: #ff6b6b; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; border: 1px solid rgba(239,68,68,0.3); }
        .success-message { background: rgba(16,185,129,0.2); color: #34d399; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; border: 1px solid rgba(16,185,129,0.3); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
        .modal-content { background: #1a1a1a; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid #333; }
        .modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 20px; font-weight: bold; }
        .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .participants-count { display: flex; align-items: center; gap: 8px; color: #667eea; font-weight: 600; margin: 15px 0; }
        .join-btn { width: 100%; margin-top: 20px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #888; }
        .empty-state i { font-size: 48px; margin-bottom: 20px; }
        .chat-section { margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .chat-messages { max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
        .chat-message { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px; padding: 10px; background: #222; border-radius: 8px; }
        .chat-avatar { width: 30px; height: 30px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; flex-shrink: 0; }
        .chat-content { flex: 1; }
        .chat-author { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .chat-text { font-size: 14px; color: #ccc; }
        .chat-time { font-size: 11px; color: #888; }
        .chat-form { display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #333; border: 1px solid #444; border-radius: 8px; padding: 10px; color: white; font-size: 14px; }
        .chat-input:focus { outline: none; border-color: #667eea; }
        .chat-send { background: #667eea; border: none; border-radius: 8px; padding: 10px 15px; color: white; cursor: pointer; }
        .people-section { margin-bottom: 30px; }
        .people-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .person-card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; text-align: center; transition: all 0.3s; }
        .person-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .person-avatar { width: 60px; height: 60px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; color: white; font-weight: bold; font-size: 20px; }
        .person-name { font-weight: 600; margin-bottom: 5px; }
        .person-bio { font-size: 12px; color: #888; margin-bottom: 10px; }
        .demo-badge { background: linear-gradient(135deg, #ff6b6b, #feca57); color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; margin-left: 10px; }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .profile-stats { gap: 20px; }
            .event-actions { flex-direction: column; }
            .people-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const SUPABASE_URL = 'https://wsmjnssfmujdfgthyizw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzbWpuc3NmbXVqZGZndGh5aXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4ODA3NjIsImV4cCI6MjA2NjQ1Njc2Mn0.t91X-fGIolFBPnhr5_sexJMqzgdCDmXuEUXiL_pFId4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { useState, useEffect } = React;

        const CATEGORIES = ['Sport', 'Musica', 'Arte', 'Cultura', 'Tecnologia', 'Cibo', 'Viaggi', 'Cinema', 'All\'aperto'];

        // Dati demo utenti per testing
        const DEMO_USERS = [
            { id: 'demo1', username: 'marco_sport', bio: 'Appassionato di calcio e tennis', location: 'Milano' },
            { id: 'demo2', username: 'anna_music', bio: 'Organizzo concerti jazz', location: 'Roma' },
            { id: 'demo3', username: 'luca_tech', bio: 'Developer e maker', location: 'Torino' },
            { id: 'demo4', username: 'sara_arte', bio: 'Pittrice e curatrice', location: 'Firenze' },
            { id: 'demo5', username: 'giorgio_food', bio: 'Chef e food blogger', location: 'Bologna' }
        ];

        // Componente Onboarding
        function Onboarding({ onComplete }) {
            const [isSignIn, setIsSignIn] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let result;
                    if (isSignIn) {
                        result = await supabase.auth.signInWithPassword({ email, password });
                    } else {
                        result = await supabase.auth.signUp({ email, password });
                    }
                    if (result.error) {
                        setError(result.error.message);
                    } else {
                        if (result.data.user) {
                            // Crea/aggiorna profilo
                            await supabase.from('profiles').upsert({
                                id: result.data.user.id,
                                username: result.data.user.email.split('@')[0],
                                bio: 'Nuovo su SocialNet',
                                location: 'Italia'
                            });
                            onComplete(result.data.user);
                        }
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="onboarding">
                    <div className="onboarding-card">
                        <div className="logo">SN</div>
                        <h1>SocialNet</h1>
                        <p>Connettiti con eventi e persone</p>
                        <div className="auth-tabs">
                            <button className={`auth-tab ${isSignIn ? 'active' : ''}`} onClick={() => setIsSignIn(true)}>Accedi</button>
                            <button className={`auth-tab ${!isSignIn ? 'active' : ''}`} onClick={() => setIsSignIn(false)}>Registrati</button>
                        </div>
                        <form onSubmit={handleAuth}>
                            <div className="form-group">
                                <input type="email" className="form-input" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            </div>
                            <div className="form-group">
                                <input type="password" className="form-input" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                            </div>
                            {error && <div className="error-message">{error}</div>}
                            <button type="submit" className="btn-primary" disabled={loading}>
                                {loading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-sign-in-alt"></i>}
                                {isSignIn ? 'Accedi' : 'Registrati'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Chat Evento Component
        function EventChat({ eventId, user, isParticipant }) {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (isParticipant) {
                    loadMessages();
                    // Realtime subscription
                    const channel = supabase.channel('event_chats')
                        .on('postgres_changes', {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'event_chats',
                            filter: `event_id=eq.${eventId}`
                        }, (payload) => {
                            loadMessages(); // Ricarica i messaggi
                        })
                        .subscribe();

                    return () => {
                        supabase.removeChannel(channel);
                    };
                }
            }, [eventId, isParticipant]);

            const loadMessages = async () => {
                try {
                    const { data, error } = await supabase
                        .from('event_chats')
                        .select(`
                            id,
                            content,
                            created_at,
                            profiles!event_chats_user_id_fkey(username)
                        `)
                        .eq('event_id', eventId)
                        .order('created_at', { ascending: true });

                    if (!error) {
                        setMessages(data || []);
                    }
                } catch (err) {
                    console.error('Errore caricamento chat:', err);
                } finally {
                    setLoading(false);
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !isParticipant) return;

                try {
                    await supabase
                        .from('event_chats')
                        .insert({
                            event_id: eventId,
                            user_id: user.id,
                            content: newMessage.trim()
                        });
                    
                    setNewMessage('');
                } catch (err) {
                    console.error('Errore invio messaggio:', err);
                }
            };

            if (!isParticipant) {
                return (
                    <div className="chat-section">
                        <div className="section-title">
                            <i className="fas fa-lock"></i>
                            Chat evento
                        </div>
                        <div className="empty-state">
                            <i className="fas fa-lock"></i>
                            <h3>Chat privata</h3>
                            <p>Partecipa all'evento per accedere alla chat</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="chat-section">
                    <div className="section-title">
                        <i className="fas fa-comments"></i>
                        Chat evento
                    </div>
                    
                    {loading ? (
                        <div className="loading"><div className="spinner"></div></div>
                    ) : (
                        <>
                            <div className="chat-messages">
                                {messages.length === 0 ? (
                                    <div className="empty-state">
                                        <i className="fas fa-comment-slash"></i>
                                        <p>Nessun messaggio. Inizia la conversazione!</p>
                                    </div>
                                ) : (
                                    messages.map(msg => (
                                        <div key={msg.id} className="chat-message">
                                            <div className="chat-avatar">
                                                {msg.profiles?.username?.[0]?.toUpperCase() || 'U'}
                                            </div>
                                            <div className="chat-content">
                                                <div className="chat-author">{msg.profiles?.username || 'Utente'}</div>
                                                <div className="chat-text">{msg.content}</div>
                                                <div className="chat-time">
                                                    {new Date(msg.created_at).toLocaleTimeString('it-IT', {
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                            
                            <form onSubmit={sendMessage} className="chat-form">
                                <input
                                    type="text"
                                    className="chat-input"
                                    placeholder="Scrivi un messaggio..."
                                    value={newMessage}
                                    onChange={(e) => setNewMessage(e.target.value)}
                                    required
                                />
                                <button type="submit" className="chat-send">
                                    <i className="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </>
                    )}
                </div>
            );
        }

        // Modal Evento con Chat
        function EventModal({ event, onClose, user, onJoinToggle }) {
            const [participants, setParticipants] = useState([]);
            const [isJoined, setIsJoined] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadParticipants();
            }, []);

            const loadParticipants = async () => {
                try {
                    const { data, error } = await supabase
                        .from('event_participants')
                        .select(`
                            user_id,
                            profiles!event_participants_user_id_fkey(username)
                        `)
                        .eq('event_id', event.id);

                    if (!error) {
                        setParticipants(data || []);
                        setIsJoined(data?.some(p => p.user_id === user.id) || false);
                    }
                } catch (err) {
                    console.error('Errore caricamento partecipanti:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleJoinToggle = async () => {
                try {
                    if (isJoined) {
                        await supabase
                            .from('event_participants')
                            .delete()
                            .eq('event_id', event.id)
                            .eq('user_id', user.id);
                    } else {
                        await supabase
                            .from('event_participants')
                            .insert({
                                event_id: event.id,
